!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("rxjs"),require("@angular/common/http"),require("ngx-cookie-service"),require("uuid"),require("@angular/router"),require("@angular/common")):"function"==typeof define&&define.amd?define("@codaglobal/ng-s3-analytics",["exports","@angular/core","rxjs","@angular/common/http","ngx-cookie-service","uuid","@angular/router","@angular/common"],e):e((t.codaglobal=t.codaglobal||{},t.codaglobal["ng-s3-analytics"]={}),t.ng.core,t.rxjs,t.ng.common.http,null,null,t.ng.router,t.ng.common)}(this,function(t,e,i,r,n,a,o,s){"use strict";var c=function(){function t(){}return t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),l=function(){function t(){}return t.prototype.ngOnInit=function(){},t.decorators=[{type:e.Component,args:[{selector:"lib-ng-s3-analytics",template:"\n    <p>\n      ng-s3-analytics works!\n    </p>\n  ",styles:[]}]}],t.ctorParameters=function(){return[]},t}();function u(t,a,s,c){return new(s||(s=Promise))(function(e,n){function o(t){try{i(c.next(t))}catch(e){n(e)}}function r(t){try{i(c["throw"](t))}catch(e){n(e)}}function i(t){t.done?e(t.value):function n(e){return e instanceof s?e:new s(function(t){t(e)})}(t.value).then(o,r)}i((c=c.apply(t,a||[])).next())})}function p(o,r){var i,a,s,t,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,a&&(s=2&t[0]?a["return"]:t[0]?a["throw"]||((s=a["return"])&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){c.label=t[1];break}if(6===t[0]&&c.label<s[1]){c.label=s[1],s=t;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(t);break}s[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(o,c)}catch(e){t=[6,e],a=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}function h(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],o=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function f(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var o,r,i=n.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(o=i.next()).done;)a.push(o.value)}catch(s){r={error:s}}finally{try{o&&!o.done&&(n=i["return"])&&n.call(i)}finally{if(r)throw r.error}}return a}function g(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t}var y={dataCollectionApi:"https://1xgf5a2bq2.execute-api.ap-south-1.amazonaws.com/dev/",isPageLoadingToBeDetected:!0,remoteConfigApi:"",ignoreUrls:[],ignoreCssRules:[],showConsent:!1,consentContent:"We use cookies to ensure that we provide you with the best possible experience on our website.If you continue to use our site, we assume you accept our use of cookies. Privacy Policy",disableTracking:!1,ignoreIPRanges:"",ignoreDomains:[],disableDemographicInfo:!1},d={PAGE_LOAD:"PAGE_LOAD",MOUSE_HOVER:"MOUSE_HOVER",BUTTON_CLICK:"BUTTON_CLICK",MOUSE_MOVE:"MOUSE_MOVE",SCROLL:"SCROLL",CONSOLE_ERROR:"CONSOLE_ERROR",KEY_STROKE:"KEY_STROKE"},v={DEMOGRAPHIC_INFO:"demographic-info",SESSION_ID:"ngS3AnalyticsSessionId",DEMOGRAPHIC_API_URL:"https://ipapi.co/json/"},m=function j(){this.key="",this.keyCode="",this.elementId="",this.isForm=!1,this.form="",this.tagName="",this.htmlElementType="",this.value="",this.code=""},S=function(){function t(){this.envConfig=new i.Subject}return t.prototype.setConfigurationToEnvironment=function(t,e){y.dataCollectionApi=t.dataCollectionApi,y.isPageLoadingToBeDetected=e,y.remoteConfigApi=t.remoteConfigApi,this.envConfig.next(y),this.envConfig.complete()},t.prototype.getEnvObservable=function(){return this.envConfig},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),C=function(){function t(t,e,n){this.httpClient=t,this.injector=e,this.cookieService=n,this.constants=v}return t.prototype.getEnvironmentConfig=function(){var e=this;this.injector.get(S).getEnvObservable().subscribe(function(t){e.fetchRemoteConfig()},function(t){console.error("unable to fetch xAnalytics remote configuration. Please make sure you have configured the correct URL, if the issue persist please check the dashboard for more info or contact xA Team. ")})},t.prototype.fetchRemoteConfig=function(){var n=this;this.httpClient.get(y.remoteConfigApi).subscribe(function(t){if(n.remotePluginConfig=t.body,n.remotePluginConfig.showConsent){var e=n.remotePluginConfig.consentContent?n.remotePluginConfig.consentContent:y.consentContent;n.checkShowConsent(e)}},function(t){console.error("collection error",t)})},t.prototype.handleConfiguration=function(t){return this.checkDisableTracking()&&this.checkDomain(t.fullURL)&&this.checkIpRange(t.demographicInfo.ip)},t.prototype.checkDisableTracking=function(){return!this.remotePluginConfig||!this.remotePluginConfig.disableTracking},t.prototype.checkDomain=function(e){return!(this.remotePluginConfig&&0<this.remotePluginConfig.ignoreDomains.length)||!(0<this.remotePluginConfig.ignoreDomains.filter(function(t){return 0<=e.indexOf(t)}).length)},t.prototype.removeCheckUrls=function(t){var n=this;return t&&0<t.length&&this.remotePluginConfig?t.map(function(e){if(!(0<n.remotePluginConfig.ignoreUrls.filter(function(t){return 0<=e.eventComponent.indexOf(t)}).length))return e}).filter(function(t){return t!==undefined}):t},t.prototype.checkIpRange=function(t){if(t&&this.remotePluginConfig&&0<this.remotePluginConfig.ignoreIPRanges.length){var e=this.remotePluginConfig.ignoreIPRanges;return!t.match(e)}return!0},t.prototype.getIp=function(){return u(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return[4,(e=this).httpClient.get(this.constants.DEMOGRAPHIC_API_URL).toPromise()];case 1:return e.demographicInfo=t.sent(),this.cookieService.set(this.constants.DEMOGRAPHIC_INFO,JSON.stringify(this.demographicInfo),new Date((new Date).getTime()+864e5)),[2,this.demographicInfo]}})})},t.prototype.setDemographicInfo=function(){return this.cookieService.check(this.constants.DEMOGRAPHIC_INFO)?this.demographicInfo=JSON.parse(this.cookieService.get(this.constants.DEMOGRAPHIC_INFO)):this.getIp(),this.demographicInfo},t.prototype.getDemographicInfo=function(){return this.remotePluginConfig&&this.remotePluginConfig.disableDemographicInfo?{}:this.setDemographicInfo()},t.prototype.checkShowConsent=function(t){var e=document.createElement("div");e.classList.add("consent-wrapper"),e.style.position="fixed",e.style.bottom="0",e.style.left="0",e.style.right="0",e.style.padding="15px",e.style.backgroundColor="#3366ff",e.style.color="#fff",e.style.fontSize="12px",e.style.textAlign="center";var n=document.createTextNode(t);e.appendChild(n),document.body.appendChild(e)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:r.HttpClient},{type:e.Injector},{type:n.CookieService}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(r.HttpClient),e.inject(e.INJECTOR),e.inject(n.CookieService))},token:t,providedIn:"root"}),t}(),b=function(){function t(t,e){this.httpService=t,this.pluginConfig=e,this.demographicInfo={},this.eventLabels=d,this.constants=v,this.pluginConfig.getEnvironmentConfig(),this.setSessionId()}return t.prototype.setSessionId=function(){sessionStorage.getItem(this.constants.SESSION_ID)?this.sessionId=sessionStorage.getItem(this.constants.SESSION_ID):(this.sessionId=a.v4(),sessionStorage.setItem(this.constants.SESSION_ID,this.sessionId))},t.prototype.pushData=function(t){if(this.pluginConfig.handleConfiguration(t.eventValues[0])){var e=this.pluginConfig.removeCheckUrls(t.eventValues);this.publishTOAuthS3(e)}},t.prototype.processForAthena=function(t){var e=this;return t&&0<t.length?t.map(function(t){return t.sessionId=e.sessionId,JSON.stringify(t)}).join("\n"):JSON.stringify(t)},t.prototype.publishTOAuthS3=function(t){var e=(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_"+(new Date).toISOString()+".json",n=new r.HttpHeaders({"Content-Type":"application/json"});this.pushDataToS3(e,this.processForAthena(t),n)},t.prototype.pushDataToS3=function(t,e,n){var o=""+y.dataCollectionApi+t;this.httpService.put(o,e,{headers:n}).subscribe(function(t){},function(t){console.log(t)})},t.prototype.saveScreenshotsInS3=function(t,e){if(this.pluginConfig.checkDisableTracking()){var n="assets/"+(new Date).toISOString().split("T")[0]+"/"+this.sessionId+"/"+e+".html",o=new r.HttpHeaders({"Content-Type":"text/html"});this.pushDataToS3(n,t,o)}},t.prototype.publishConsoleErrors=function(t){if(this.pluginConfig.checkDisableTracking()){t.sessionId=this.sessionId;var e=(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_console_errors_"+(new Date).getTime()+".json",n=new r.HttpHeaders({"Content-Type":"application/json"});this.pushDataToS3(e,t,n)}},t.prototype.setAnalyticsData=function(t,e,n,o,r){return void 0===t&&(t={}),{eventLabel:n,eventComponent:r&&r.eventComponent?r.eventComponent:window.location.pathname.split("?")[0],browser:window.navigator.userAgent,fullURL:window.location.href,origin:window.location.origin,resolution:window.innerWidth+"x"+window.innerHeight,xCoord:this.getEventDetails(e.clientX),yCoord:this.getEventDetails(e.clientY),pageXCoord:window.pageXOffset.toString()||"0",pageYCoord:window.pageYOffset.toString()||"0",eventTime:(new Date).toISOString(),screenshot:o,additionalInfo:t,errors:r&&r.consoleErrors?r.consoleErrors:"",utm:this.getUTMParameters(window.location.href),demographicInfo:this.pluginConfig.getDemographicInfo(),keyStrokeData:r&&r.keyStrokeData?r.keyStrokeData:this.getEmptyKeyStrokeData(),htmlElement:this.getHtmlElement(e.target,n),performance:this.getPerformanceDetails()}},t.prototype.getEventDetails=function(t){return t!==undefined?t.toString():"0"},t.prototype.getHtmlElement=function(t,e){return e!==this.eventLabels.MOUSE_MOVE&&e!==this.eventLabels.SCROLL&&t!==undefined?t.innerHTML:""},t.prototype.getEmptyKeyStrokeData=function(){return{key:"",keyCode:"",code:"",elementId:"",form:"",htmlElementType:"",isForm:!1,tagName:"",value:""}},t.prototype.getPerformanceDetails=function(){var t=window.performance;return{navigation:t.navigation,timeOrigin:t.timeOrigin,timing:t.timing}},t.prototype.geMemoryUsageInfo=function(t){return 1<t.split("chrome").length?window.performance.memory:""},t.prototype.getUTMParameters=function(t){var n={};t.includes("utm")&&t.split("?")[1].split("&").map(function(t){var e=t.split("=");n[e[0]]=e[1]});return n},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:r.HttpClient},{type:C}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(r.HttpClient),e.inject(C))},token:t,providedIn:"root"}),t}(),I=function(){function t(t,e){this.analyticalService=t,this.http=e,this.allDataAnalyticsArray=[],this.keys=[],this.eventCollector=new Map,this.routeDetails=[],this.count=0}return t.prototype.setUrlKey=function(t){var e,n,o=0;if(this.previousUrl===undefined)this.eventCollector.set(t,[]),this.previousUrl=t||"/";else if(t!==this.previousUrl){try{for(var r=h(Array.from(this.eventCollector.keys())),i=r.next();!i.done;i=r.next()){if(i.value===t){o=1;break}}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}0===o&&this.eventCollector.set(t,[]),this.previousUrl=t}},t.prototype.appendToAnalyticsArray=function(t){this.previousUrl===undefined&&this.setUrlKey(t.eventComponent),this.eventCollector.get(this.previousUrl).push(t)},t.prototype.pushDataArrayToS3=function(){var t,e,n,o;this.count++;try{for(var r=h(Array.from(this.eventCollector.keys())),i=r.next();!i.done;i=r.next()){var a=i.value;this.allDataAnalytics={pageUrl:a,eventValues:Array.from(this.eventCollector.get(a).values())},this.keys.push(a),0<this.allDataAnalytics.eventValues.length&&this.analyticalService.pushData(this.allDataAnalytics)}}catch(l){t={error:l}}finally{try{i&&!i.done&&(e=r["return"])&&e.call(r)}finally{if(t)throw t.error}}this.eventCollector.clear();try{for(var s=h(this.keys),c=s.next();!c.done;c=s.next()){a=c.value;this.eventCollector.set(a,[])}}catch(u){n={error:u}}finally{try{c&&!c.done&&(o=s["return"])&&o.call(s)}finally{if(n)throw n.error}}},t.prototype.setRouteDetails=function(t){this.routeDetails=t},t.prototype.getRouteDetails=function(){return this.routeDetails},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:b},{type:r.HttpClient}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(b),e.inject(r.HttpClient))},token:t,providedIn:"root"}),t}(),D=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.data={},this.eventLabels=d}return t.prototype.onClick=function(t){this.eventDetails=t,this.sendData()},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.BUTTON_CLICK,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:e.Directive,args:[{selector:"[track-btn]"}]}],t.ctorParameters=function(){return[{type:I},{type:b}]},t.propDecorators={data:[{type:e.Input,args:["track-btn"]}],onClick:[{type:e.HostListener,args:["click",["$event"]]}]},t}(),k=function(){function t(t,e){this.analyticsService=t,this.dataStorage=e,this.data={},this.eventLabels=d}return t.prototype.ngOnChanges=function(t){this.data=t.data.currentValue},t.prototype.onScrollEvent=function(t){var e=this;setTimeout(function(){e.sendData(t)},100)},t.prototype.sendData=function(t){var e=this.analyticsService.setAnalyticsData(this.data,t,this.eventLabels.SCROLL,"");this.dataStorage.appendToAnalyticsArray(e)},t.decorators=[{type:e.Directive,args:[{selector:"[track-scroll]"}]}],t.ctorParameters=function(){return[{type:b},{type:I}]},t.propDecorators={data:[{type:e.Input,args:["track-scroll"]}],onScrollEvent:[{type:e.HostListener,args:["window:scroll",["$event"]]}]},t}(),w=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.eventLabels=d,this.data={}}return t.prototype.onMouseOver=function(t){var e=this;this.eventDetails=t,setTimeout(function(){e.sendData()},10)},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.MOUSE_HOVER,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:e.Directive,args:[{selector:"[track-buttonHover]"}]}],t.ctorParameters=function(){return[{type:I},{type:b}]},t.propDecorators={data:[{type:e.Input,args:["track-buttonHover"]}],onMouseOver:[{type:e.HostListener,args:["mouseover",["$event"]]}]},t}(),O=function(){function t(t,e,n){this.routes=t,this.analyticsService=e,this.dataStorage=n,this.eventLabels=d,this.navigateOn=""}return t.prototype.trackRouterEvents=function(){var e=this;this.routes.events.subscribe(function(t){t instanceof o.NavigationEnd?e.navigateOn!==t.url&&(e.analyticsPushData(t),e.navigateOn=t.url):t instanceof o.NavigationError&&e.analyticsPushData(t)})},t.prototype.analyticsPushData=function(t){var e=this,n=(new Date).getTime().toString();this.analyticsData=this.analyticsService.setAnalyticsData({},{},this.eventLabels.PAGE_LOAD,n+".html",{eventComponent:t.url}),this.waitTillPageLoad(n),this.dataStorage.setUrlKey(this.analyticsData.eventComponent),setTimeout(function(){e.dataStorage.appendToAnalyticsArray(e.analyticsData)},0)},t.prototype.waitTillPageLoad=function(t){var e=this,n=setInterval(function(){"complete"===document.readyState&&(clearInterval(n),e.captureTemplate(t))},1e3)},t.prototype.captureTemplate=function(t){var e=ngS3AnalyticsJS.constructHTMLPage(this.processRegexOperations(document.querySelector("head").innerHTML),this.processRegexOperations(document.querySelector("body").innerHTML));this.analyticsService.saveScreenshotsInS3(e,t)},t.prototype.processRegexOperations=function(t){return ngS3AnalyticsJS.doRegex(t,window.location.origin)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:o.Router},{type:b},{type:I}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(o.Router),e.inject(b),e.inject(I))},token:t,providedIn:"root"}),t}(),E=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.eventLabels=d,this.data={}}return t.prototype.trackMouseMoveEvent=function(){var e=this;i.fromEvent(window,"mousemove").subscribe(function(t){e.eventDetails=t,e.sendData()})},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.MOUSE_MOVE,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:I},{type:b}]},t.propDecorators={data:[{type:e.Input,args:["track-pointer"]}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(I),e.inject(b))},token:t,providedIn:"root"}),t}(),A=function(){function t(t){this.injector=t,this.eventLabels=d}return t.prototype.trackConsoleErrors=function(){var r=this.injector.get(b),i=this.injector.get(I);if(window.console&&console.error){var a=console.error,s=this;console.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t.map(function(t){return"object"==typeof t?JSON.stringify(t):t}),o=r.setAnalyticsData("",{},s.eventLabels.CONSOLE_ERROR,"",{consoleErrors:JSON.stringify(n)});i.appendToAnalyticsArray(o),a.call(console,t)}}},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:e.Injector}]},t}(),T=function(){function t(t,e,n,o){if(this.dataStorage=t,this.analyticsService=e,this.el=n,this.renderer=o,this.eventLabels=d,!this.el.nativeElement.id){var r="key_stroke_element_"+a.v4();this.renderer.setAttribute(this.el.nativeElement,"id",r)}}return t.prototype.onKeyStroke=function(t){var e=new m;"password"!==t.target.type&&this.checkClassNames(t.target.classList)&&(e.elementId=t.target.id,e.key=t.key,e.code=t.code,e.keyCode=t.keyCode.toString(),e.isForm=t.target.form!==undefined,e.form=t.target.form!==undefined?JSON.stringify(t.target.form.elements):"",e.tagName=t.target.tagName,e.htmlElementType=t.target.type,e.value=t.target.value,this.sendData(e,t))},t.prototype.checkClassNames=function(t){var e=g(t).concat(y.ignoreCssRules);return g(new Set(e)).length===e.length},t.prototype.sendData=function(t,e){var n=this.analyticsService.setAnalyticsData({},e,this.eventLabels.KEY_STROKE,"",{keyStrokeData:t});this.dataStorage.appendToAnalyticsArray(n)},t.decorators=[{type:e.Directive,args:[{selector:"[track-keyStroke]"}]}],t.ctorParameters=function(){return[{type:I},{type:b},{type:e.ElementRef},{type:e.Renderer2}]},t.propDecorators={onKeyStroke:[{type:e.HostListener,args:["keypress",["$event"]]}]},t}(),P=function(){function t(t,e,n,o){var r=this;this.routerService=t,this.dataStorage=e,this.pointerService=n,this.errorhandler=o,window.addEventListener("beforeunload",function(t){r.dataStorage.pushDataArrayToS3()}),i.interval(2e3).subscribe(function(t){r.dataStorage.pushDataArrayToS3()}),this.pointerService.trackMouseMoveEvent(),this.routerService.trackRouterEvents(),this.errorhandler.trackConsoleErrors()}return t.forRoot=function(t,e){void 0===e&&(e=!1),this.environmentService.setConfigurationToEnvironment(t,e)},t.environmentService=new S,t.decorators=[{type:e.NgModule,args:[{imports:[s.CommonModule,r.HttpClientModule],declarations:[l,D,k,w,T],providers:[I,S,E,n.CookieService,A],exports:[l,D,k,w,T]}]}],t.ctorParameters=function(){return[{type:O},{type:I},{type:E},{type:A}]},t}();t.NgS3AnalyticsService=c,t.NgS3AnalyticsComponent=l,t.NgS3AnalyticsModule=P,t.EnvironmentService=S,t.DataStorageService=I,t.ɵe=w,t.ɵa=D,t.ɵf=T,t.ɵd=k,t.ɵb=b,t.ɵc=C,t.ɵh=A,t.ɵg=E,t.ɵi=O,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=codaglobal-ng-s3-analytics.umd.min.js.map
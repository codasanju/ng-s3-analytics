!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("uuid"),require("ngx-cookie-service"),require("@angular/common/http"),require("@angular/router"),require("rxjs"),require("@angular/common")):"function"==typeof define&&define.amd?define("@codaglobal/ng-s3-analytics",["exports","@angular/core","uuid","ngx-cookie-service","@angular/common/http","@angular/router","rxjs","@angular/common"],e):e((t.codaglobal=t.codaglobal||{},t.codaglobal["ng-s3-analytics"]={}),t.ng.core,null,null,t.ng.common.http,t.ng.router,t.rxjs,t.ng.common)}(this,function(t,e,i,n,r,o,a,s){"use strict";var c=function(){function t(){}return t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),l=function(){function t(){}return t.prototype.ngOnInit=function(){},t.decorators=[{type:e.Component,args:[{selector:"lib-ng-s3-analytics",template:"\n    <p>\n      ng-s3-analytics works!\n    </p>\n  ",styles:[]}]}],t.ctorParameters=function(){return[]},t}();function u(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],o=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var p={dataCollectionApi:"https://1xgf5a2bq2.execute-api.ap-south-1.amazonaws.com/dev/",isPageLoadingToBeDetected:!0,restrictIPRange:""},h={PAGE_LOAD:"PAGE_LOAD",MOUSE_HOVER:"MOUSE_HOVER",BUTTON_CLICK:"BUTTON_CLICK",MOUSE_MOVE:"MOUSE_MOVE",SCROLL:"SCROLL",CONSOLE_ERROR:"CONSOLE_ERROR",KEY_STROKE:"KEY_STROKE"},y={DEMOGRAPHIC_INFO:"demographic-info",SESSION_ID:"ngS3AnalyticsSessionId",DEMOGRAPHIC_API_URL:"https://ipapi.co/json/"},d=function k(){},f=function(){function t(t,e){this.cookieService=t,this.httpService=e,this.demographicInfo={},this.eventLabels=h,this.constants=y,this.cookieService.check(this.constants.DEMOGRAPHIC_INFO)?this.demographicInfo=JSON.parse(this.cookieService.get(this.constants.DEMOGRAPHIC_INFO)):this.getIp(),this.setSessionId()}return t.prototype.setSessionId=function(){sessionStorage.getItem(this.constants.SESSION_ID)?this.sessionId=sessionStorage.getItem(this.constants.SESSION_ID):(this.sessionId=i.v4(),sessionStorage.setItem(this.constants.SESSION_ID,this.sessionId))},t.prototype.pushData=function(t){this.checkIpRange()&&this.publishTOAuthS3(t)},t.prototype.checkIpRange=function(){var t=p.restrictIPRange;return!t||!this.demographicInfo.ip||!this.demographicInfo.ip.match(t)},t.prototype.processForAthena=function(t){var e=this;return t.map(function(t){return t.sessionId=e.sessionId,JSON.stringify(t)}).join("\n")},t.prototype.publishTOAuthS3=function(t){var e=(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_"+(new Date).toISOString()+".json",n=new r.HttpHeaders({"Content-Type":"application/json"});this.pushDataToS3(e,this.processForAthena(t.eventValues),n)},t.prototype.pushDataToS3=function(t,e,n){var o=""+p.dataCollectionApi+t;this.httpService.put(o,e,{headers:n}).subscribe(function(t){},function(t){console.log(t)})},t.prototype.saveScreenshotsInS3=function(t,e){var n="assets/"+(new Date).toISOString().split("T")[0]+"/"+this.sessionId+"/"+e+".html",o=new r.HttpHeaders({"Content-Type":"text/html"});this.pushDataToS3(n,t,o)},t.prototype.publishConsoleErrors=function(t){t.sessionId=this.sessionId;var e=(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_console_errors_"+(new Date).getTime()+".json",n=new r.HttpHeaders({"Content-Type":"application/json"});this.pushDataToS3(e,t,n)},t.prototype.setAnalyticsData=function(t,e,n,o,r){return void 0===t&&(t={}),{eventLabel:n,eventComponent:r&&r.eventComponent?r.eventComponent:window.location.pathname.split("?")[0],browser:window.navigator.userAgent,fullURL:window.location.href,origin:window.location.origin,resolution:window.innerWidth+"x"+window.innerHeight,xCoord:this.getEventDetails(e.clientX),yCoord:this.getEventDetails(e.clientY),pageXCoord:window.pageXOffset.toString()||"0",pageYCoord:window.pageYOffset.toString()||"0",eventTime:(new Date).toISOString(),screenshot:o,additionalInfo:t,errors:r&&r.consoleErrors?r.consoleErrors:"",utm:this.getUTMParameters(window.location.href),demographicInfo:this.demographicInfo,keyStrokeData:r&&r.keyStrokeData?r.keyStrokeData:this.getEmptyKeyStrokeData(),htmlElement:this.getHtmlElement(e.target),performance:this.getPerformanceDetails()}},t.prototype.getEventDetails=function(t){return t!==undefined?t.toString():"0"},t.prototype.getHtmlElement=function(t){return t!==undefined?t.innerHTML:""},t.prototype.getEmptyKeyStrokeData=function(){return{key:"",keyCode:"",code:"",elementId:"",form:"",htmlElementType:"",isForm:!1,tagName:"",value:""}},t.prototype.getPerformanceDetails=function(){var t=window.performance;return{navigation:t.navigation,timeOrigin:t.timeOrigin,timing:t.timing}},t.prototype.geMemoryUsageInfo=function(t){return 1<t.split("chrome").length?window.performance.memory:""},t.prototype.getUTMParameters=function(t){var n={};t.includes("utm")&&t.split("?")[1].split("&").map(function(t){var e=t.split("=");n[e[0]]=e[1]});return n},t.prototype.getIp=function(){var e=this;this.httpService.get(this.constants.DEMOGRAPHIC_API_URL).subscribe(function(t){e.demographicInfo=t,e.cookieService.set(e.constants.DEMOGRAPHIC_INFO,JSON.stringify(t),new Date((new Date).getTime()+864e5))})},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:n.CookieService},{type:r.HttpClient}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(n.CookieService),e.inject(r.HttpClient))},token:t,providedIn:"root"}),t}(),v=function(){function t(t,e){this.analyticalService=t,this.http=e,this.allDataAnalyticsArray=[],this.keys=[],this.eventCollector=new Map,this.routeDetails=[],this.count=0}return t.prototype.setUrlKey=function(t){var e,n,o=0;if(this.previousUrl===undefined)this.eventCollector.set(t,[]),this.previousUrl=t||"/";else if(t!==this.previousUrl){try{for(var r=u(Array.from(this.eventCollector.keys())),i=r.next();!i.done;i=r.next()){if(i.value===t){o=1;break}}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}0===o&&this.eventCollector.set(t,[]),this.previousUrl=t}},t.prototype.appendToAnalyticsArray=function(t){this.previousUrl===undefined&&this.setUrlKey(t.eventComponent),this.eventCollector.get(this.previousUrl).push(t)},t.prototype.pushDataArrayToS3=function(){var t,e,n,o;this.count++;try{for(var r=u(Array.from(this.eventCollector.keys())),i=r.next();!i.done;i=r.next()){var a=i.value;this.allDataAnalytics={pageUrl:a,eventValues:Array.from(this.eventCollector.get(a).values())},this.keys.push(a),0<this.allDataAnalytics.eventValues.length&&this.analyticalService.pushData(this.allDataAnalytics)}}catch(l){t={error:l}}finally{try{i&&!i.done&&(e=r["return"])&&e.call(r)}finally{if(t)throw t.error}}this.eventCollector.clear();try{for(var s=u(this.keys),c=s.next();!c.done;c=s.next()){a=c.value;this.eventCollector.set(a,[])}}catch(p){n={error:p}}finally{try{c&&!c.done&&(o=s["return"])&&o.call(s)}finally{if(n)throw n.error}}},t.prototype.setRouteDetails=function(t){this.routeDetails=t},t.prototype.getRouteDetails=function(){return this.routeDetails},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:f},{type:r.HttpClient}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(f),e.inject(r.HttpClient))},token:t,providedIn:"root"}),t}(),g=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.data={},this.eventLabels=h}return t.prototype.onClick=function(t){var e=this;this.eventDetails=t,setTimeout(function(){e.sendData()},10)},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.BUTTON_CLICK,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:e.Directive,args:[{selector:"[track-btn]"}]}],t.ctorParameters=function(){return[{type:v},{type:f}]},t.propDecorators={data:[{type:e.Input,args:["track-btn"]}],onClick:[{type:e.HostListener,args:["click",["$event"]]}]},t}(),S=function(){function t(t,e){this.analyticsService=t,this.dataStorage=e,this.data={},this.eventLabels=h}return t.prototype.ngOnChanges=function(t){this.data=t.data.currentValue},t.prototype.onScrollEvent=function(t){var e=this;setTimeout(function(){e.sendData(t)},100)},t.prototype.sendData=function(t){var e=this.analyticsService.setAnalyticsData(this.data,t,this.eventLabels.SCROLL,"");this.dataStorage.appendToAnalyticsArray(e)},t.decorators=[{type:e.Directive,args:[{selector:"[track-scroll]"}]}],t.ctorParameters=function(){return[{type:f},{type:v}]},t.propDecorators={data:[{type:e.Input,args:["track-scroll"]}],onScrollEvent:[{type:e.HostListener,args:["window:scroll",["$event"]]}]},t}(),m=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.eventLabels=h,this.data={}}return t.prototype.onMouseOver=function(t){var e=this;this.eventDetails=t,setTimeout(function(){e.sendData()},10)},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.MOUSE_HOVER,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:e.Directive,args:[{selector:"[track-buttonHover]"}]}],t.ctorParameters=function(){return[{type:v},{type:f}]},t.propDecorators={data:[{type:e.Input,args:["track-buttonHover"]}],onMouseOver:[{type:e.HostListener,args:["mouseover",["$event"]]}]},t}(),I=function(){function t(){}return t.prototype.setConfigurationToEnvironment=function(t,e){p.dataCollectionApi=t.dataCollectionApi,p.isPageLoadingToBeDetected=e,p.restrictIPRange=t.restrictIPRange},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),D=function(){function t(t,e,n){this.routes=t,this.analyticsService=e,this.dataStorage=n,this.eventLabels=h,this.navigateOn=""}return t.prototype.trackRouterEvents=function(){var e=this;this.routes.events.subscribe(function(t){t instanceof o.NavigationEnd?e.navigateOn!==t.url&&(e.analyticsPushData(t),e.navigateOn=t.url):t instanceof o.NavigationError&&e.analyticsPushData(t)})},t.prototype.analyticsPushData=function(t){var e=this,n=(new Date).getTime().toString();this.analyticsData=this.analyticsService.setAnalyticsData({},{},this.eventLabels.PAGE_LOAD,n+".html",{eventComponent:t.url}),this.waitTillPageLoad(n),this.dataStorage.setUrlKey(this.analyticsData.eventComponent),setTimeout(function(){e.dataStorage.appendToAnalyticsArray(e.analyticsData)},0)},t.prototype.waitTillPageLoad=function(t){var e=this,n=setInterval(function(){"complete"===document.readyState&&(clearInterval(n),e.captureTemplate(t))},1e3)},t.prototype.captureTemplate=function(t){var e=ngS3AnalyticsJS.constructHTMLPage(this.processRegexOperations(document.querySelector("head").innerHTML),this.processRegexOperations(document.querySelector("body").innerHTML));this.analyticsService.saveScreenshotsInS3(e,t)},t.prototype.processRegexOperations=function(t){return ngS3AnalyticsJS.doRegex(t,window.location.origin)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:o.Router},{type:f},{type:v}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(o.Router),e.inject(f),e.inject(v))},token:t,providedIn:"root"}),t}(),O=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.eventLabels=h,this.data={}}return t.prototype.trackMouseMoveEvent=function(){var e=this;a.fromEvent(window,"mousemove").subscribe(function(t){e.eventDetails=t,e.sendData()})},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.MOUSE_MOVE,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:v},{type:f}]},t.propDecorators={data:[{type:e.Input,args:["track-pointer"]}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(v),e.inject(f))},token:t,providedIn:"root"}),t}(),b=function(){function t(t){this.injector=t,this.eventLabels=h}return t.prototype.trackConsoleErrors=function(){var r=this.injector.get(f),i=this.injector.get(v);if(window.console&&console.error){var a=console.error,s=this;console.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t.map(function(t){return"object"==typeof t?JSON.stringify(t):t}),o=r.setAnalyticsData("",{},s.eventLabels.CONSOLE_ERROR,"",{consoleErrors:JSON.stringify(n)});i.appendToAnalyticsArray(o),a.call(console,t)}}},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:e.Injector}]},t}(),E=function(){function t(t,e,n,o){if(this.dataStorage=t,this.analyticsService=e,this.el=n,this.renderer=o,this.eventLabels=h,!this.el.nativeElement.id){var r="key_stroke_element_"+i.v4();this.renderer.setAttribute(this.el.nativeElement,"id",r)}}return t.prototype.onKeyStroke=function(t){var e=new d;e.elementId=t.target.id,e.key=t.key,e.code=t.code,e.keyCode=t.keyCode.toString(),e.isForm=t.target.form!==undefined,e.form=t.target.form!==undefined?JSON.stringify(t.target.form.elements):"",e.tagName=t.target.tagName,e.htmlElementType=t.target.type,e.value=t.target.value,this.sendData(e,t)},t.prototype.sendData=function(t,e){var n=this.analyticsService.setAnalyticsData({},e,this.eventLabels.KEY_STROKE,"",{keyStrokeData:t});this.dataStorage.appendToAnalyticsArray(n)},t.decorators=[{type:e.Directive,args:[{selector:"[track-keyStroke]"}]}],t.ctorParameters=function(){return[{type:v},{type:f},{type:e.ElementRef},{type:e.Renderer2}]},t.propDecorators={onKeyStroke:[{type:e.HostListener,args:["keypress",["$event"]]}]},t}(),C=function(){function t(t,e,n,o){var r=this;this.routerService=t,this.dataStorage=e,this.pointerService=n,this.errorhandler=o,window.addEventListener("beforeunload",function(t){r.dataStorage.pushDataArrayToS3()}),a.interval(2e3).subscribe(function(t){r.dataStorage.pushDataArrayToS3()}),this.pointerService.trackMouseMoveEvent(),this.routerService.trackRouterEvents(),this.errorhandler.trackConsoleErrors()}return t.forRoot=function(t,e){void 0===e&&(e=!1),this.environmentService.setConfigurationToEnvironment(t,e)},t.environmentService=new I,t.decorators=[{type:e.NgModule,args:[{imports:[s.CommonModule,r.HttpClientModule],declarations:[l,g,S,m,E],providers:[v,I,O,n.CookieService,b],exports:[l,g,S,m,E]}]}],t.ctorParameters=function(){return[{type:D},{type:v},{type:O},{type:b}]},t}();t.NgS3AnalyticsService=c,t.NgS3AnalyticsComponent=l,t.NgS3AnalyticsModule=C,t.EnvironmentService=I,t.DataStorageService=v,t.ɵd=m,t.ɵa=g,t.ɵe=E,t.ɵc=S,t.ɵb=f,t.ɵg=b,t.ɵf=O,t.ɵh=D,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=codaglobal-ng-s3-analytics.umd.min.js.map
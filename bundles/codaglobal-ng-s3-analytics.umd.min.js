!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("aws-sdk"),require("uuid"),require("ngx-cookie-service"),require("@angular/common/http"),require("moment"),require("@angular/router"),require("@angular/platform-browser"),require("rxjs"),require("@angular/common")):"function"==typeof define&&define.amd?define("@codaglobal/ng-s3-analytics",["exports","@angular/core","aws-sdk","uuid","ngx-cookie-service","@angular/common/http","moment","@angular/router","@angular/platform-browser","rxjs","@angular/common"],e):e((t.codaglobal=t.codaglobal||{},t.codaglobal["ng-s3-analytics"]={}),t.ng.core,null,null,null,t.ng.common.http,null,t.ng.router,t.ng.platformBrowser,t.rxjs,t.ng.common)}(this,function(t,o,e,n,r,i,a,s,c,u,l){"use strict";var p=function(){function t(){}return t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=o.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),h=function(){function t(){}return t.prototype.ngOnInit=function(){},t.decorators=[{type:o.Component,args:[{selector:"lib-ng-s3-analytics",template:"\n    <p>\n      ng-s3-analytics works!\n    </p>\n  ",styles:[]}]}],t.ctorParameters=function(){return[]},t}();function d(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}var y={accessKeyId:"",secretAccessKey:"",sessionToken:"",bucketName:{authenticatedBucket:"",publicBucket:"",screenshotBucket:""},fileName:"",region:"",isAuth:!1,isPageLoadingToBeDetected:!0},f=a,v=function(){function t(t,e){this.cookieService=t,this.httpService=e,this.demographicInfo={},this.cookieService.check("demographic-info")?this.demographicInfo=JSON.parse(this.cookieService.get("demographic-info")):this.getIp(),this.setSessionId()}return t.prototype.setSessionId=function(){this.cookieService.check("ngS3AnalyticsSessionId")?this.sessionId=this.cookieService.get("ngS3AnalyticsSessionId"):(this.sessionId=n.v4(),this.cookieService.set("ngS3AnalyticsSessionId",this.sessionId,new Date((new Date).getTime()+36e5)))},t.prototype.pushData=function(t){y.isAuth?this.publishTOAuthS3(t):this.publishTOUnAuthS3(t)},t.prototype.publishTOUnAuthS3=function(t){var e=this.constructS3Object(),n={Bucket:y.bucketName.publicBucket,Key:(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_"+(new Date).toISOString()+".json",Body:this.processForAthena(t.eventValues),ContentType:"json"};e.putObject(n,function(t,e){t&&console.error(t)})},t.prototype.processForAthena=function(t){var e=this;return t.map(function(t){return t.sessionId=e.sessionId,JSON.stringify(t)}).join("\n")},t.prototype.publishTOAuthS3=function(t){var e=this.constructS3Object(),n={Bucket:y.bucketName.authenticatedBucket,Key:(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_"+(new Date).toISOString()+".json",Body:this.processForAthena(t.eventValues),ContentType:"json"};e.putObject(n,function(t,e){t&&console.error("error",t)})},t.prototype.constructS3Object=function(){return new e.S3({accessKeyId:y.accessKeyId,secretAccessKey:y.secretAccessKey,region:y.region})},t.prototype.saveScreenshotsInS3=function(t,e){var n=this.constructS3Object(),o={Bucket:y.bucketName.screenshotBucket,Key:(new Date).toISOString().split("T")[0]+"/"+this.sessionId+"/screenshots/"+e+".html",Body:t,ContentType:"text/html"};n.upload(o,function(t,e){t&&console.error(t)})},t.prototype.publishConsoleErrors=function(t){var e=this.constructS3Object();t.sessionId=this.sessionId;var n={Bucket:y.bucketName.authenticatedBucket,Key:(new Date).toISOString().split("T")[0]+"_"+this.sessionId+"_console_errors_"+(new Date).getTime()+".json",Body:JSON.stringify(t),ContentType:"json"};e.putObject(n,function(t,e){t&&console.log(t)})},t.prototype.setAnalyticsData=function(t,e,n,o,r){return void 0===t&&(t={}),{eventLabel:n,eventComponent:r||window.location.pathname.split("?")[0],browser:window.navigator.userAgent,fullURL:window.location.href,resolution:window.innerWidth+"x"+window.innerHeight,xCoord:e.clientX!==undefined?e.clientX.toString():"0",yCoord:e.clientY!==undefined?e.clientY.toString():"0",pageXCoord:window.pageXOffset.toString()||"0",pageYCoord:window.pageYOffset.toString()||"0",eventTime:f.utc(new Date).format("YYYY-MM-DD HH:mm:ss"),screenshot:o,additionalInfo:t,utm:this.getUTMParameters(window.location.href),demographicInfo:this.demographicInfo}},t.prototype.getUTMParameters=function(t){var n={};t.includes("utm")&&t.split("?")[1].split("&").map(function(t){var e=t.split("=");n[e[0]]=e[1]});return n},t.prototype.getIp=function(){var e=this;this.httpService.get("https://ipapi.co/json/").subscribe(function(t){e.demographicInfo=t,e.cookieService.set("demographic-info",JSON.stringify(t),new Date((new Date).getTime()+6048e5))})},t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:r.CookieService},{type:i.HttpClient}]},t.ngInjectableDef=o.defineInjectable({factory:function(){return new t(o.inject(r.CookieService),o.inject(i.HttpClient))},token:t,providedIn:"root"}),t}(),g=function(){function t(t,e){this.analyticalService=t,this.http=e,this.allDataAnalyticsArray=[],this.keys=[],this.eventCollector=new Map,this.routeDetails=[],this.count=0}return t.prototype.setUrlKey=function(t){var e,n,o=0;if(this.previousUrl===undefined)this.eventCollector.set(t,[]),this.previousUrl=t;else if(t!==this.previousUrl){try{for(var r=d(Array.from(this.eventCollector.keys())),i=r.next();!i.done;i=r.next()){if(i.value===t){o=1;break}}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}0===o&&this.eventCollector.set(t,[]),this.previousUrl=t}},t.prototype.appendToAnalyticsArray=function(t){this.eventCollector.get(this.previousUrl).push(t)},t.prototype.pushDataArrayToS3=function(){var t,e,n,o;this.count++;try{for(var r=d(Array.from(this.eventCollector.keys())),i=r.next();!i.done;i=r.next()){var a=i.value;this.allDataAnalytics={pageUrl:a,eventValues:Array.from(this.eventCollector.get(a).values())},this.keys.push(a),0<this.allDataAnalytics.eventValues.length&&this.analyticalService.pushData(this.allDataAnalytics)}}catch(u){t={error:u}}finally{try{i&&!i.done&&(e=r["return"])&&e.call(r)}finally{if(t)throw t.error}}this.eventCollector.clear();try{for(var s=d(this.keys),c=s.next();!c.done;c=s.next()){a=c.value;this.eventCollector.set(a,[])}}catch(l){n={error:l}}finally{try{c&&!c.done&&(o=s["return"])&&o.call(s)}finally{if(n)throw n.error}}},t.prototype.setRouteDetails=function(t){this.routeDetails=t},t.prototype.getRouteDetails=function(){return this.routeDetails},t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:v},{type:i.HttpClient}]},t.ngInjectableDef=o.defineInjectable({factory:function(){return new t(o.inject(v),o.inject(i.HttpClient))},token:t,providedIn:"root"}),t}(),m={PAGE_LOAD:"PAGE_LOAD",MOUSE_HOVER:"MOUSE_HOVER",BUTTON_CLICK:"BUTTON_CLICK",MOUSE_MOVE:"MOUSE_MOVE",SCROLL:"SCROLL",CONSOLE_ERROR:"CONSOLE_ERROR"},S=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.data={},this.eventLabels=m}return t.prototype.onClick=function(t){var e=this;this.eventDetails=t,setTimeout(function(){e.sendData()},10)},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.BUTTON_CLICK,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:o.Directive,args:[{selector:"[track-btn]"}]}],t.ctorParameters=function(){return[{type:g},{type:v}]},t.propDecorators={data:[{type:o.Input,args:["track-btn"]}],onClick:[{type:o.HostListener,args:["click",["$event"]]}]},t}(),b=function(){function t(t,e){this.analyticsService=t,this.dataStorage=e,this.data={},this.eventLabels=m}return t.prototype.ngOnChanges=function(t){this.data=t.data.currentValue},t.prototype.onScrollEvent=function(t){var e=this;setTimeout(function(){e.sendData(t)},100)},t.prototype.sendData=function(t){var e=this.analyticsService.setAnalyticsData(this.data,t,this.eventLabels.SCROLL,"");this.dataStorage.appendToAnalyticsArray(e)},t.decorators=[{type:o.Directive,args:[{selector:"[track-scroll]"}]}],t.ctorParameters=function(){return[{type:v},{type:g}]},t.propDecorators={data:[{type:o.Input,args:["track-scroll"]}],onScrollEvent:[{type:o.HostListener,args:["window:scroll",["$event"]]}]},t}(),k=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.eventLabels=m,this.data={}}return t.prototype.onMouseOver=function(t){var e=this;this.eventDetails=t,setTimeout(function(){e.sendData()},10)},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.MOUSE_HOVER,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:o.Directive,args:[{selector:"[track-buttonHover]"}]}],t.ctorParameters=function(){return[{type:g},{type:v}]},t.propDecorators={data:[{type:o.Input,args:["track-buttonHover"]}],onMouseOver:[{type:o.HostListener,args:["mouseover",["$event"]]}]},t}(),I=function(){function t(){}return t.prototype.setAuthentication=function(t){y.isAuth=t},t.prototype.setCredentialsToEnvironment=function(t,e){if(y.accessKeyId=t.accessKeyId,y.fileName=t.fileName,y.secretAccessKey=t.secretAccessKey,y.sessionToken=t.sessionToken,y.region=t.region,y.isPageLoadingToBeDetected=e,""!==t.bucketName.authenticatedBucket&&""!==t.bucketName.publicBucket)y.bucketName={authenticatedBucket:t.bucketName.authenticatedBucket,publicBucket:t.bucketName.publicBucket,screenshotBucket:t.bucketName.screenshotBucket};else{var n=""===t.bucketName.authenticatedBucket?t.bucketName.publicBucket:t.bucketName.authenticatedBucket;y.bucketName={authenticatedBucket:n,publicBucket:n,screenshotBucket:t.bucketName.screenshotBucket}}},t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ngInjectableDef=o.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),D=function(){function t(t,e,n,o){this.routes=t,this.analyticsService=e,this.dataStorage=n,this.document=o,this.eventLabels=m}return t.prototype.trackRouterEvents=function(){var e=this;this.routes.events.subscribe(function(t){t instanceof s.NavigationEnd&&e.analyticsPushData(t),t instanceof s.NavigationError&&e.analyticsPushData(t)})},t.prototype.analyticsPushData=function(t){var e=(new Date).getTime().toString();this.analyticsData=this.analyticsService.setAnalyticsData({},{},this.eventLabels.PAGE_LOAD,e+".html",t.url),this.waitTillPageLoad(e),this.dataStorage.setUrlKey(this.analyticsData.eventComponent),this.dataStorage.appendToAnalyticsArray(this.analyticsData)},t.prototype.waitTillPageLoad=function(t){var e=this,n=setInterval(function(){"complete"===this.document.readyState&&(clearInterval(n),e.captureTemplate(t))},2e3)},t.prototype.captureTemplate=function(t){var e="<html>\n      <head>\n        "+this.processRegexOperations(this.document.head.innerHTML)+"\n        <style>body {scroll-behavior: smooth;}</style>\n      </head>\n      <body>\n        "+this.processRegexOperations(this.document.body.innerHTML)+'\n        <script>\n          window.addEventListener("message", (e) => {\n            try{\n              if(e.customData) {\n              var data = JSON.parse(e.customData);\n              if (data.scroll) {\n                window.scroll(0, data.value);\n              };\n            }\n          }catch(e) {console.log(e);}\n          });\n        <\/script>\n      </body>\n    </html>';this.analyticsService.saveScreenshotsInS3(e,t)},t.prototype.processRegexOperations=function(t){return t.replace(/src=\"\//g,'src="'+window.location.origin+"/").replace(/url\(\"\//g,'url("'+window.location.origin+"/").replace(/href="\//g,'href="'+window.location.origin+"/").replace(/src=\'\//g,"src='"+window.location.origin+"/").replace(/url\(\'\//g,"url('"+window.location.origin+"/").replace(/href=\'\//g,"href='"+window.location.origin+"/").replace(/<script.*<\/script>/g,"").replace(/href="(?!http)/g,'href="'+window.location.origin+"/")},t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:s.Router},{type:v},{type:g},{type:undefined,decorators:[{type:o.Inject,args:[c.DOCUMENT]}]}]},t.ngInjectableDef=o.defineInjectable({factory:function(){return new t(o.inject(s.Router),o.inject(v),o.inject(g),o.inject(c.DOCUMENT))},token:t,providedIn:"root"}),t}(),w=function(){function t(t,e){this.dataStorage=t,this.analyticsService=e,this.eventLabels=m,this.data={}}return t.prototype.trackMouseMoveEvent=function(){var e=this;u.fromEvent(window,"mousemove").subscribe(function(t){e.eventDetails=t,e.sendData()})},t.prototype.sendData=function(){var t=this.analyticsService.setAnalyticsData(this.data,this.eventDetails,this.eventLabels.MOUSE_MOVE,"");this.dataStorage.appendToAnalyticsArray(t)},t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:g},{type:v}]},t.propDecorators={data:[{type:o.Input,args:["track-pointer"]}]},t.ngInjectableDef=o.defineInjectable({factory:function(){return new t(o.inject(g),o.inject(v))},token:t,providedIn:"root"}),t}(),O=function(){function t(t){this.injector=t,this.eventLabels=m;var r=this.injector.get(v);if(window.console&&console.error){var i=console.error;console.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t.map(function(t){return"object"==typeof t?JSON.stringify(t):t}),o=r.setAnalyticsData(n,{},this.eventLabels.CONSOLE_ERROR,"");r.publishConsoleErrors(o),i.call(console,t)}}}return t.prototype.handleError=function(t){},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:o.Injector}]},t}(),A=function(){function n(t,e,n){var o=this;this.routerService=t,this.dataStorage=e,this.pointerService=n,u.interval(1e4).subscribe(function(t){o.dataStorage.pushDataArrayToS3()}),this.pointerService.trackMouseMoveEvent(),this.routerService.trackRouterEvents()}return n.forRoot=function(t,e){return void 0===e&&(e=!1),this.environmentService.setCredentialsToEnvironment(t,e),{ngModule:n,providers:[{provide:o.ErrorHandler,useClass:O}]}},n.environmentService=new I,n.decorators=[{type:o.NgModule,args:[{imports:[l.CommonModule,i.HttpClientModule],declarations:[h,S,b,k],providers:[g,I,w,r.CookieService],exports:[h,S,b,k]}]}],n.ctorParameters=function(){return[{type:D},{type:g},{type:w}]},n}();t.NgS3AnalyticsService=p,t.NgS3AnalyticsComponent=h,t.NgS3AnalyticsModule=A,t.EnvironmentService=I,t.DataStorageService=g,t.ɵd=k,t.ɵa=S,t.ɵc=b,t.ɵb=v,t.ɵe=w,t.ɵf=D,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=codaglobal-ng-s3-analytics.umd.min.js.map